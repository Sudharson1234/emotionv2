<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Emotion Detection - emoti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-theme.css') }}">
    <style>
        .detection-container {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .video-container {
            background: rgba(37, 45, 61, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            padding: 20px;
        }

        video {
            width: 100%;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
        }

        .video-upload-box {
            border: 2px dashed var(--accent-primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background: rgba(0, 212, 255, 0.02);
            transition: var(--transition);
        }

        .video-upload-box:hover {
            background: rgba(0, 212, 255, 0.05);
            border-color: var(--accent-secondary);
        }

        .video-upload-box.dragging {
            background: rgba(0, 212, 255, 0.15);
            border-color: var(--accent-secondary);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--accent-primary);
            margin-bottom: 15px;
        }

        .controls-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 15px;
            background: rgba(37, 45, 61, 0.3);
            border-radius: 8px;
        }

        .emotion-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .emotion-stat-box {
            background: rgba(37, 45, 61, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: var(--transition);
        }

        .emotion-stat-box:hover {
            background: rgba(37, 45, 61, 0.5);
            border-color: var(--accent-primary);
        }

        .stat-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .stat-name {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .timeline-container {
            background: rgba(37, 45, 61, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .timeline-point {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .timeline-point:last-child {
            border-bottom: none;
        }

        .timeline-time {
            color: var(--accent-primary);
            font-weight: 700;
            min-width: 50px;
        }

        .timeline-emotion {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (max-width: 768px) {
            .video-section {
                grid-template-columns: 1fr;
            }

            .emotion-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .detection-container {
                padding: 20px 15px;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="/">
                <i class="fas fa-heart-pulse"></i> emoti
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/userpage"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/chat"><i class="fas fa-comment"></i> Chat</a></li>
                    <li class="nav-item"><a class="nav-link" href="/image_detection"><i class="fas fa-image"></i>
                            Image</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/video_detection"><i class="fas fa-video"></i>
                            Video</a></li>
                    <li class="nav-item"><a class="nav-link" href="/text_detection"><i class="fas fa-file-alt"></i>
                            Text</a></li>
                    <li class="nav-item"><a class="nav-link" href="/analytics"><i class="fas fa-chart-line"></i>
                            Analytics</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i>
                            Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Container -->
    <div class="detection-container">
        <div class="page-header">
            <h1><i class="fas fa-video"></i> Video Emotion Detection</h1>
            <p>Analyze emotions frame-by-frame in video files</p>
        </div>

        <!-- Video Section -->
        <div class="video-section">
            <!-- Video Player -->
            <div class="dashboard-card">
                <div class="section-title">
                    <i class="fas fa-play-circle"></i> Video Player
                </div>
                <div class="video-container">
                    <video id="videoPlayer" controls></video>
                </div>
                <div class="controls-area">
                    <button class="btn btn-primary btn-sm" id="uploadBtn">
                        <i class="fas fa-upload"></i> Select Video
                    </button>
                    <button class="btn btn-primary btn-sm" id="analyzeBtn" disabled>
                        <i class="fas fa-play"></i> Analyze Video
                    </button>
                    <input type="file" id="videoInput" accept="video/*" style="display: none;">
                </div>
            </div>

            <!-- Analysis Results -->
            <div class="dashboard-card">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i> Emotion Analysis
                </div>
                <div class="emotion-stats" id="statsContainer">
                    <div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 20px;">
                        <p>Upload and analyze a video to see results</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Section -->
        <div class="dashboard-card">
            <div class="section-title">
                <i class="fas fa-history"></i> Emotion Timeline
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h6
                        style="color: var(--text-secondary); font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px;">
                        <i class="fas fa-list"></i> Detected Emotions (by frame)
                    </h6>
                    <div class="timeline-container" id="timelineContainer">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            No data yet
                        </div>
                    </div>
                </div>
                <div>
                    <h6
                        style="color: var(--text-secondary); font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px;">
                        <i class="fas fa-chart-pie"></i> Emotion Distribution
                    </h6>
                    <div class="emotion-stats" id="distributionContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const emotionEmojis = {
            'joy': 'üòä', 'sadness': 'üò¢', 'sad': 'üò¢',
            'anger': 'üò†', 'angry': 'üò†', 'fear': 'üò®',
            'disgust': 'ü§¢', 'surprise': 'üòÆ', 'neutral': 'üòê'
        };

        const emotionColors = {
            'joy': '#FFD700', 'sadness': '#1E90FF', 'sad': '#1E90FF',
            'anger': '#FF4444', 'angry': '#FF4444', 'fear': '#9932CC',
            'disgust': '#32CD32', 'surprise': '#FF6347', 'neutral': '#A9A9A9'
        };

        let selectedFile = null;
        let analysisData = {};

        document.addEventListener('DOMContentLoaded', () => {
            const uploadBtn = document.getElementById('uploadBtn');
            const videoInput = document.getElementById('videoInput');
            const analyzeBtn = document.getElementById('analyzeBtn');

            uploadBtn.addEventListener('click', () => videoInput.click());
            videoInput.addEventListener('change', handleVideoSelect);
            analyzeBtn.addEventListener('click', analyzeVideo);
        });

        function handleVideoSelect() {
            const videoInput = document.getElementById('videoInput');
            selectedFile = videoInput.files[0];

            if (selectedFile) {
                const videoPlayer = document.getElementById('videoPlayer');
                const url = URL.createObjectURL(selectedFile);
                videoPlayer.src = url;
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        async function analyzeVideo() {
            if (!selectedFile) {
                alert('Please select a video file');
                return;
            }

            const formData = new FormData();
            formData.append('video', selectedFile);

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';

            try {
                const response = await fetch('/detect_video_emotion', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Analysis failed');

                analysisData = data;
                displayResults(data);
                trackEmotions(data);

            } catch (error) {
                alert('Error analyzing video: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Analyze Video';
            }
        }

        function displayResults(data) {
            if (!data.emotions || data.emotions.length === 0) {
                alert('No emotions detected in the video');
                return;
            }

            // Calculate statistics
            const emotionCounts = {};
            let totalConfidence = {};

            for (const emotion of data.emotions) {
                if (!emotionCounts[emotion.emotion]) {
                    emotionCounts[emotion.emotion] = 0;
                    totalConfidence[emotion.emotion] = 0;
                }
                emotionCounts[emotion.emotion]++;
                totalConfidence[emotion.emotion] += emotion.confidence || 0;
            }

            // Display emotion stats
            let statsHtml = '';
            for (const [emotion, count] of Object.entries(emotionCounts)) {
                const emotionLower = emotion.toLowerCase();
                const percentage = Math.round((count / data.emotions.length) * 100);
                const avgConfidence = Math.round((totalConfidence[emotion] / count) * 100);

                statsHtml += `
                    <div class="emotion-stat-box">
                        <div class="stat-emoji">${emotionEmojis[emotionLower] || 'üòê'}</div>
                        <div class="stat-name">${emotion}</div>
                        <div class="stat-value">${count}</div>
                        <small style="color: var(--text-secondary);">${percentage}% of frames</small>
                        <div style="margin-top: 5px; font-size: 11px; color: var(--accent-primary);">Avg: ${avgConfidence}%</div>
                    </div>
                `;
            }

            document.getElementById('statsContainer').innerHTML = statsHtml;

            // Display timeline
            let timelineHtml = '';
            for (let i = 0; i < Math.min(data.emotions.length, 30); i++) {
                const emotion = data.emotions[i];
                const emotionLower = emotion.emotion.toLowerCase();
                const frameNum = i + 1;
                timelineHtml += `
                    <div class="timeline-point">
                        <div class="timeline-time">Frame ${frameNum}</div>
                        <div class="timeline-emotion" style="color: ${emotionColors[emotionLower] || '#888'};">
                            ${emotionEmojis[emotionLower] || 'üòê'} ${emotion.emotion}
                        </div>
                    </div>
                `;
            }

            document.getElementById('timelineContainer').innerHTML = timelineHtml || '<p>No timeline data</p>';

            // Display distribution
            let distHtml = '';
            for (const [emotion, count] of Object.entries(emotionCounts).sort((a, b) => b[1] - a[1])) {
                const emotionLower = emotion.toLowerCase();
                const percentage = Math.round((count / data.emotions.length) * 100);

                distHtml += `
                    <div class="emotion-stat-box" style="grid-column: 1/-1;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 28px;">${emotionEmojis[emotionLower] || 'üòê'}</div>
                            <div style="flex: 1; text-align: left;">
                                <div style="color: ${emotionColors[emotionLower] || '#888'}; font-weight: 700; margin-bottom: 5px;">${emotion}</div>
                                <div style="background: var(--border-color); height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: ${emotionColors[emotionLower] || '#888'}; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--accent-primary); font-weight: 700;">${percentage}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('distributionContainer').innerHTML = distHtml;
        }

        async function trackEmotions(data) {
            if (!data.emotions) return;

            // Get the most common emotion for tracking
            const emotionCounts = {};
            for (const emotion of data.emotions) {
                emotionCounts[emotion.emotion] = (emotionCounts[emotion.emotion] || 0) + 1;
            }

            const dominantEmotion = Object.entries(emotionCounts).sort((a, b) => b[1] - a[1])[0];
            if (dominantEmotion) {
                const avgConfidence = dominantEmotion[1] / data.emotions.length;

                try {
                    await fetch('/api/track-emotion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            emotion: dominantEmotion[0].toLowerCase(),
                            source: 'video',
                            confidence: avgConfidence,
                            metadata: {
                                total_frames: data.emotions.length,
                                emotion_distribution: emotionCounts
                            }
                        })
                    });
                } catch (error) {
                    console.error('Error tracking emotion:', error);
                }
            }
        }
    </script>
</body>

</html>